define("app",function(a,b,c){var d=a("helper/base");d.autoload=function(b,c){a.async(b,c)},d.error=function(a){d.tips(a)},d.success=function(a){d.tips(a)},d.tips=function(a){alert(a)};var e=d.MainView.extend({events:{}});d.mainView=new e,d.router=new d.Router({mainView:d.mainView,defaultController:"index",Controller:{index:"page/index",demo:"page/demo"}}),Backbone.oldAjax=Backbone.ajax,Backbone.ajax=function(a){a.dataType="jsonp",(0!=a.url.indexOf("http")||0!=a.url.indexOf("https"))&&(a.url=seajs.config().data.apiBase+(0==a.url.indexOf("/")?a.url:"/"+a.url));var b=a.success,c=a.error;a.success=a.error=null;var e=Backbone.oldAjax.apply(Backbone,arguments),f=$.Deferred();e.done(function(a){0!==a.code?f.reject(e,a):f.resolve(a.data)}),e.fail(function(a,b,c){f.reject(a,{})}),f.done(function(a){return b&&b(a),a});var g=f.reject;f.reject=function(a,b){var e=!0;return"rejected"!==f.state()&&f.fail(function(a,b){var f="网络错误，请重试！";return b.msg&&(f=b.msg),"abort"!==a.statusText&&e&&d.error(f),c&&c(b),b}),g.call(f,a,b,function(a){e=a})};var h=f.promise();return h.abort=function(){e.abort.apply(e,arguments)},h},Backbone.history.start()}),define("helper/base",function(a,b,c){!function(a,c){"function"==typeof define&&define.amd?define(["exports","underscore","backbone"],c):"object"==typeof b?c(b,a._,a.Backbone):c(a.app={},a._,a.Backbone)}(window,function(a,b,c){var d=a,e=function(){return this.__instache||(this.__instache=new this),this.__instache};d.autoload=function(a,b){throw new Error("app.autoload is abstract function, override it.")};var f=function(a,d){var e=b.toArray(arguments),f=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;if(b.has(a,"constructor")&&f.test(a.constructor)){var g=a.constructor;a.constructor=function(){var a=this._super;this._super=j.constructor;var b=g.apply(this,arguments);return this._super=a,b}}var h=c.Model.extend.apply(this,e),i=h.prototype,j=h.__super__;for(var k in a)i[k]="function"==typeof a[k]&&"function"==typeof j[k]&&f.test(a[k])?function(a,b){return function(){var c=this._super;this._super=j[a];var d=b.apply(this,arguments);return this._super=c,d}}(k,a[k]):a[k];return h};d.BaseView=c.View.extend({app:d,constructor:function(){this.ajaxQueue=[],c.View.apply(this,arguments)},ajax:function(){var a=this,b=c.ajax.apply(this,arguments);if(!b.abort)throw new Error("");return b.always(function(){var c=a.ajaxQueue,d=c.indexOf(b);c.splice(d,1)}),this.ajaxQueue.push(b),b},abortAjaxQueue:function(){var a=this;b.each(a.ajaxQueue,function(a){a&&a.abort&&a.abort()}),this.ajaxQueue=[]}},{singleton:e,extend:f}),d.BaseModel=c.Model.extend({app:d},{singleton:e,extend:f}),d.BaseCollection=c.Collection.extend({app:d},{singleton:e,extend:f}),d.MainView=d.BaseView.extend({el:document.body}),d.ActionView=d.BaseView.extend({onStage:!1,viewWillAddStage:function(){},viewAddedStage:function(){},viewBeActive:function(){},viewBeInActive:function(){},viewWillRemoveStage:function(){},viewRemovedStage:function(){},destroy:function(){}}),d.ControllerView=d.ActionView.extend({defaultAction:"index",errorAction:null,Actions:{},activeParams:null,activeAction:null,prepareAction:function(a){if(a&&a in this.Actions||(a=this.errorAction||this.defaultAction),!(a in this.actions)){var b=this.Actions[a].extend({controller:this});this.actions[a]=new b,this.actions[a].$el.addClass(a+"Action")}return a},runAction:function(a){var b=this.actions[a];b.onStage||(b.onStage=!0,b.viewWillAddStage(),this.appendAction(b),b.viewAddedStage())},appendAction:function(a){this.$el.append(a.$el)},dispath:function(a,b){var c=this.actions[a];this.activeAction&&this.activeAction!=a&&this.actions[this.activeAction]&&this.destroyAction(this.activeAction),this.activeAction=a,c.$el.show(),c.params=this.activeParams,c.viewBeActive(this.activeParams)},destroyAction:function(a){var c=this;b.each(this.actions,function(d,e){if(!a||a===e)if(d.abortAjaxQueue(),d.mainTain)d.$el.hide(),d.viewBeInActive();else{var f=function(){d.onStage&&(d.onStage=!1),d.$el.remove(),d.viewRemovedStage(),d.destroy(),delete c.actions[e],b.size(c.actions)||c.destroy()};d.viewWillRemoveStage.length>0?d.viewWillRemoveStage(function(){f()}):(d.viewWillRemoveStage(),f())}})},constructor:function(){this.actions={},d.ControllerView.__super__.constructor.apply(this,arguments)},parseParams:function(a){if(!a)return{};a.replace(/\/+/g,"/"),a=a.split("/");var c=b.reject(a,function(a,b){return b%2==1}),d=b.reject(a,function(a,b){return b%2==0});return b.object(c,d)},destroy:function(){return this.viewWillRemoveStage(),this.$el.remove(),this.viewRemovedStage(),b.map(this.router.controllers,function(a,b){a==this&&delete this.router.controllers[b]},this),!0},viewWillRemoveStage:function(){},viewRemovedStage:function(){}}),d.Router=c.Router.extend({app:d,module:null,routes:{"":"caRoute",":controller":"caRoute",":controller/:action":"caRoute",":controller/:action/*params":"caRoute"},previousController:null,activeController:null,previousAction:null,activeAction:null,rawParams:null,Controller:{},defaultController:"index",errorController:null,mainView:null,caRoute:function(a,c,d){d||(d="");var e,f=this;a in f.Controller||(e=b.compact([a,c,d]).join("/"),a=f.errorController||f.defaultController),f.prepareController(a,function(g){var h=g.prepareAction(c);if(f.previousAction=f.activeAction,f.activeAction=h,e||(e=h!=c?b.compact([c,d]).join("/"):d),a!=f.activeController){if(f.activeController){var i=f.controllers[f.activeController];i.destroyAction(),f.previousAction=i.activeAction,f.previousController=f.activeController}g.onStage||(g.viewWillAddStage(),f.mainView.$el.append(g.$el),g.viewAddedStage(),g.onStage=!0),g.$el.show()}f.activeController=a,g.runAction(h),g.activeParams=g.parseParams(e),g.viewBeActive(),g.dispath(h,e),f.trigger("router",a,h)})},prepareController:function(a,b){var c=this;a in this.controllers?b(this.controllers[a]):d.autoload(this.Controller[a],function(d){var e=c.controllers[a]=new d;e.router=c,e.$el.addClass(a+"Controller"),b(e)})},constructor:function(a){if(this.controllers={},a&&b.extend(this,a),this.module){var c=this.module,e={};b.each(this.routes,function(a,b){b?e[c+"/"+b]=a:e[c+b]=a},this),a.routes=e}if(d.Router.__super__.constructor.apply(this,arguments),!this.mainView)throw new Error("Router.mainView is abstract property, override it.")}})})});